<template>
  <div class="animate-logo" ref="wrapperRef">
    <svg
      ref="svgRef"
      width="1354"
      height="467"
      viewBox="0 0 1354 467"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <g filter="url(#filter0_di_1149_26)">
        <path
          d="M1133.84 60.0001C1164.45 60.0001 1190.13 59.9447 1210.47 62.5826C1231.6 65.3214 1250.98 71.3847 1266.59 86.4367C1282.19 101.489 1288.48 120.174 1291.33 140.544C1294.06 160.164 1294 184.932 1294 214.453V252.547C1294 282.067 1294.06 306.832 1291.33 326.452C1288.48 346.822 1282.19 365.511 1266.59 380.562C1250.98 395.613 1231.6 401.679 1210.47 404.417C1190.13 407.054 1164.45 407 1133.84 407H980.911C950.302 407 924.619 407.054 904.273 404.417C883.151 401.679 863.773 395.616 848.165 380.562C832.556 365.511 826.268 346.822 823.429 326.452C821.379 311.736 820.895 294.128 820.783 273.79L820.751 252.547V214.453C820.751 184.932 820.694 160.164 823.429 140.544C826.268 120.174 832.556 101.489 848.165 86.4367C863.773 71.3845 883.148 65.3214 904.273 62.5826C924.619 59.9446 950.302 60.0001 980.911 60.0001H1133.84ZM614.859 398.276H521.555L376.003 294.5L232.938 398.276H140.878L376.003 230.317L614.859 398.276ZM755.551 398.276H700.946V131.186L608.183 195.312H519.446L700.922 66.7466L700.946 66.7688V66.7466H755.551V398.276ZM980.911 112.152C948.769 112.152 927.385 112.206 911.479 114.268C896.353 116.229 890.29 119.567 886.405 123.314C882.52 127.062 879.057 132.908 877.024 147.495C874.886 162.833 874.831 183.457 874.831 214.453V252.547L874.872 273.925C874.99 293.521 875.42 308 877.024 319.505C879.057 334.092 882.52 339.938 886.405 343.685C890.29 347.433 896.356 350.767 911.479 352.728C927.385 354.789 948.769 354.847 980.911 354.847H1133.84C1165.98 354.847 1187.37 354.789 1203.28 352.728C1218.4 350.767 1224.46 347.433 1228.35 343.685C1232.23 339.938 1235.69 334.092 1237.73 319.505C1239.87 304.167 1239.92 283.542 1239.92 252.547V214.453C1239.92 183.457 1239.87 162.833 1237.73 147.495C1235.69 132.908 1232.23 127.062 1228.35 123.314C1224.46 119.567 1218.4 116.229 1203.28 114.268C1187.37 112.206 1165.98 112.152 1133.84 112.152H980.911ZM295.126 170.522L440.677 66.7466H533.98L295.126 234.705L60 66.7466H152.06L295.126 170.522Z"
          fill="#008B76"
        />

        <path
          id="path-x"
          fill="none"
          stroke="transparent"
          d="
      M613.278 397.775H521.713L376.293 294.093L376 293.884L375.709 294.096L232.776 397.775H142.438L376.005 230.93L613.278 397.775Z
      M151.897 67.2461L294.832 170.927L295.123 171.138L295.416 170.929L440.838 67.2461H532.4L295.127 234.092L61.5596 67.2461H151.897Z
    "
        />

        <path
          id="path-1"
          fill="none"
          stroke="transparent"
          d="
      M755.051 67.2461V397.775H701.446V130.232L700.662 130.775L608.027 194.812H521.015L700.877 67.3896L701.446 67.9258V67.2461H755.051Z
    "
        />

        <path
          id="path-0"
          fill="none"
          stroke="transparent"
          d="
      M980.911 60.5H1133.84C1164.47 60.5 1190.11 60.4454 1210.41 63.0781C1231.48 65.8103 1250.74 71.8503 1266.24 86.7969C1281.25 101.274 1287.6 119.145 1290.56 138.714L1290.83 140.613C1293.56 160.191 1293.5 184.918 1293.5 214.453V252.547C1293.5 281.158 1293.56 305.255 1291.08 324.532L1290.83 326.383C1287.99 346.694 1281.74 365.259 1266.24 380.202C1250.74 395.148 1231.48 401.19 1210.41 403.921C1190.11 406.553 1164.47 406.5 1133.84 406.5H980.911C950.289 406.5 924.644 406.553 904.338 403.921C883.267 401.19 864.011 395.151 848.513 380.202C833.015 365.259 826.754 346.694 823.924 326.383C821.879 311.703 821.394 294.125 821.283 273.787L821.251 252.546V214.453C821.251 184.918 821.195 160.191 823.924 140.613C826.754 120.302 833.015 101.741 848.513 86.7969C864.011 71.85 883.265 65.8103 904.338 63.0781C924.644 60.4454 950.289 60.5 980.911 60.5Z
      M980.911 111.652C948.784 111.652 927.36 111.704 911.415 113.771C896.236 115.74 890.051 119.102 886.058 122.954C882.062 126.809 878.57 132.779 876.528 147.426C874.385 162.807 874.331 183.473 874.331 214.453V252.548L874.372 273.927V273.929C874.49 293.522 874.92 308.032 876.528 319.574C878.57 334.22 882.062 340.191 886.058 344.045C890.051 347.897 896.239 351.257 911.415 353.225C927.36 355.291 948.783 355.347 980.911 355.347H1133.84C1165.97 355.347 1187.4 355.291 1203.34 353.225C1218.04 351.318 1224.3 348.106 1228.32 344.405L1228.7 344.045C1232.56 340.311 1235.96 334.591 1238.03 320.922L1238.22 319.574C1240.37 304.193 1240.42 283.526 1240.42 252.547V214.453C1240.42 184.441 1240.37 164.109 1238.42 148.884L1238.22 147.426L1238.03 146.077C1236.02 132.849 1232.78 127.066 1229.07 123.322L1228.7 122.954C1224.7 119.102 1218.52 115.74 1203.34 113.771C1187.4 111.704 1165.97 111.652 1133.84 111.652H980.911Z
    "
        />
      </g>

      <g id="trail-group" filter="url(#trailBlur)">
        <circle id="trail-0" r="15" fill="#00FFF0" opacity="0" />
        <circle id="trail-1" r="14.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-2" r="14" fill="#00FFF0" opacity="0" />
        <circle id="trail-3" r="13.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-4" r="13" fill="#00FFF0" opacity="0" />
        <circle id="trail-5" r="12.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-6" r="12" fill="#00FFF0" opacity="0" />
        <circle id="trail-7" r="11.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-8" r="11" fill="#00FFF0" opacity="0" />
        <circle id="trail-9" r="10.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-10" r="10" fill="#00FFF0" opacity="0" />
        <circle id="trail-11" r="9.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-12" r="9" fill="#00FFF0" opacity="0" />
        <circle id="trail-13" r="8.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-14" r="8" fill="#00FFF0" opacity="0" />
        <circle id="trail-15" r="7.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-16" r="7" fill="#00FFF0" opacity="0" />
        <circle id="trail-17" r="6.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-18" r="6" fill="#00FFF0" opacity="0" />
        <circle id="trail-19" r="5.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-20" r="5" fill="#00FFF0" opacity="0" />
        <circle id="trail-21" r="4.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-22" r="4" fill="#00FFF0" opacity="0" />
        <circle id="trail-23" r="3.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-24" r="3" fill="#00FFF0" opacity="0" />
        <circle id="trail-25" r="2.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-26" r="2" fill="#00FFF0" opacity="0" />
        <circle id="trail-27" r="1.5" fill="#00FFF0" opacity="0" />
        <circle id="trail-28" r="1" fill="#00FFF0" opacity="0" />
        <circle id="trail-29" r="0.5" fill="#00FFF0" opacity="0" />
      </g>

      <image
        id="runner-img"
        href="/images/runner.png"
        width="24"
        height="24"
        x="0"
        y="0"
        preserveAspectRatio="xMidYMid meet"
      />

      <defs>
        <filter
          id="filter0_di_1149_26"
          x="0"
          y="0"
          width="1354"
          height="467"
          filterUnits="userSpaceOnUse"
          color-interpolation-filters="sRGB"
        >
          <feFlood flood-opacity="0" result="BackgroundImageFix" />
          <feColorMatrix
            in="SourceAlpha"
            type="matrix"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
            result="hardAlpha"
          />
          <feOffset />
          <feGaussianBlur stdDeviation="30" />
          <feComposite in2="hardAlpha" operator="out" />
          <feColorMatrix
            type="matrix"
            values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.25 0"
          />
          <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1149_26" />
          <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1149_26" result="shape" />
          <feColorMatrix
            in="SourceAlpha"
            type="matrix"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
            result="hardAlpha2"
          />
          <feOffset />
          <feGaussianBlur stdDeviation="20" />
          <feComposite in2="hardAlpha2" operator="arithmetic" k2="-1" k3="1" />
          <feColorMatrix
            type="matrix"
            values="0 0 0 0 0.0181227 0 0 0 0 1 0 0 0 0 0.857699 0 0 0 1 0"
          />
          <feBlend mode="normal" in2="shape" result="effect2_innerShadow_1149_26" />
        </filter>

        <filter id="trailBlur">
          <feGaussianBlur stdDeviation="6" />
        </filter>
      </defs>
    </svg>
  </div>
</template>

<script setup>
import { onBeforeUnmount, onMounted, ref } from 'vue'

const wrapperRef = ref(null)
const svgRef = ref(null)
let rafId
let active = false

const cancel = () => {
  active = false
  if (rafId) {
    cancelAnimationFrame(rafId)
  }
}

onBeforeUnmount(cancel)

onMounted(() => {
  const root = wrapperRef.value
  const svg = svgRef.value
  if (!root || !svg) return

  active = true

  const paths = [
    svg.querySelector('#path-x'),
    svg.querySelector('#path-1'),
    svg.querySelector('#path-0'),
  ].filter(Boolean)

  const runner = svg.querySelector('#runner-img')
  const runnerWidth = 24
  const runnerHeight = 24

  const durations = [10000, 5000, 10000]
  const jumpDuration = 500

  const meta = paths.map((p) => {
    const len = p.getTotalLength()
    return {
      path: p,
      length: len,
      start: p.getPointAtLength(0),
      end: p.getPointAtLength(len),
    }
  })

  if (!meta.length || !runner) return

  const trailGroup = svg.querySelector('#trail-group')
  const trailCount = trailGroup?.getElementsByTagName('circle').length || 0
  const trailElems = Array.from({ length: trailCount }, (_, i) =>
    root.querySelector(`#trail-${i}`),
  )
  const trailHistory = []

  const schedule = (cb) => {
    if (!active) return
    rafId = requestAnimationFrame(cb)
  }

  const updateTrail = (x, y) => {
    trailHistory.push({ x, y })
    if (trailHistory.length > trailCount) {
      trailHistory.shift()
    }

    const len = trailHistory.length
    const maxR = 12
    const minR = 2

    for (let i = 0; i < trailCount; i += 1) {
      const circle = trailElems[i]
      if (!circle) continue

      const idx = len - 1 - i
      if (idx < 0) {
        circle.setAttribute('opacity', '0')
        continue
      }

      const p = trailHistory[idx]
      circle.setAttribute('cx', p.x)
      circle.setAttribute('cy', p.y)

      const t = i / (trailCount - 1)
      const alpha = 1 - t
      const radius = minR + (maxR - minR) * (1 - t)

      circle.setAttribute('opacity', String(alpha * 0.9))
      circle.setAttribute('r', String(radius))
    }
  }

  const easeInOutQuad = (t) => (t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t)

  const setRunnerPosition = (x, y) => {
    if (!runner) return
    runner.setAttribute('x', String(x - runnerWidth / 2))
    runner.setAttribute('y', String(y - runnerHeight / 2))
  }

  const animateOnPath = (index, startTs) => {
    const { path, length } = meta[index]
    const duration = durations[index]

    const frame = (ts) => {
      if (!active) return
      if (startTs == null) startTs = ts
      const elapsed = ts - startTs
      const progress = elapsed / duration

      if (progress >= 1) {
        const nextIndex = (index + 1) % meta.length
        schedule((t) => animateJump(index, nextIndex, t))
        return
      }

      const dist = length * progress
      const p = path.getPointAtLength(dist)

      setRunnerPosition(p.x, p.y)
      updateTrail(p.x, p.y)

      schedule(frame)
    }

    schedule(frame)
  }

  const animateJump = (fromIndex, toIndex, startTs) => {
    const from = meta[fromIndex].end
    const to = meta[toIndex].start

    const ctrl = {
      x: (from.x + to.x) / 2,
      y: (from.y + to.y) / 2 - 80,
    }

    const frame = (ts) => {
      if (!active) return
      if (startTs == null) startTs = ts
      const elapsed = ts - startTs
      const t = Math.min(elapsed / jumpDuration, 1)
      const te = easeInOutQuad(t)

      const x = (1 - te) * (1 - te) * from.x + 2 * (1 - te) * te * ctrl.x + te * te * to.x
      const y = (1 - te) * (1 - te) * from.y + 2 * (1 - te) * te * ctrl.y + te * te * to.y

      setRunnerPosition(x, y)
      updateTrail(x, y)

      if (t < 1) {
        schedule(frame)
      } else {
        schedule((t2) => animateOnPath(toIndex, t2))
      }
    }

    schedule(frame)
  }

  if (meta.length) {
    setRunnerPosition(meta[0].start.x, meta[0].start.y)
    animateOnPath(0)
  }
})
</script>

<style lang="scss" scoped src="./animate-logo.scss"></style>